#include "handmade.h"

#define DEBUG_SILENCE 0
void GameOutputSound(game_state *GameState, game_sound_output_buffer *SoundBuffer, int ToneHz)
{
  int16_t ToneVolume = 6000;
  int WavePeriod = SoundBuffer->SamplesPerSecond / ToneHz;

  int16_t *SampleOut = SoundBuffer->Samples;

  for (int SampleIndex = 0; SampleIndex < SoundBuffer->SampleCount; ++SampleIndex){
    real32 SineValue = sinf(GameState->tSine) * DEBUG_SILENCE;
    int16_t SampleValue = (int16_t)(SineValue * ToneVolume);
    *SampleOut++ = SampleValue;
    *SampleOut++ = SampleValue;

    GameState->tSine += 2.0f * Pi32 * 1.0f / (real32)WavePeriod;
    if (GameState->tSine > 2.0f*Pi32){
      GameState->tSine -= 2.0f*Pi32;
    }
  }
}


void RenderWeirdGradient(game_offscreen_buffer *Buffer, int XOffset, int YOffset)
{
  //TODO: Let's see what the optimizer does
  uint8_t *Row = (uint8_t *)Buffer->Memory;

  for (int y = 0; y < Buffer->Height; y++){

    uint32_t *Pixel = (uint32_t *)Row;

    for (int x = 0; x < Buffer->Width; x++){
      /*
        Pixel in memory: 00 00 00 00
                         BB GG RR XX
        0x XXRRGGBB
      */
      uint8_t Blue = (uint8_t)(x + XOffset);
      uint8_t Green = (uint8_t)(y + YOffset);
      uint8_t Red = uint8_t((x + y) / 16);

      *Pixel++ = ((Red << 16) | (Green << 8) | Blue);
    }
    Row += Buffer->Pitch;
  }
}

internal void RenderPlayer(game_offscreen_buffer *Buffer, int PlayerX, int PlayerY)
{
  uint8_t *EndOfBuffer = (uint8_t*)Buffer->Memory + Buffer->BytesPerPixel*Buffer->Width + Buffer->Pitch*Buffer->Height;
  uint32_t Color = 0xFFFFFFFF;
  int Top = PlayerY;
  int Bottom = PlayerY + 10;

  for (int X = PlayerX; X < PlayerX + 10; ++X)
  {
      uint8_t *Pixel = ((uint8_t *)(Buffer->Memory) + X*Buffer->BytesPerPixel + Top*Buffer->Pitch);
      for (int Y = Top; Y < Bottom; ++Y)
      {
        if ((Pixel >= Buffer->Memory) && (Pixel < EndOfBuffer))
        {
          *(uint32_t *)Pixel = Color;
          Pixel += Buffer->Pitch;
        }
      }
  }
}


extern "C" GAME_UPDATE_AND_RENDER(GameUpdateAndRender)
{
  Assert((&Input->Controllers[0].Terminator - &Input->Controllers[0].Buttons[0]) == (ArrayCount(Input->Controllers[0].Buttons)));
  Assert(sizeof(game_state) <= Memory->PermanentStorageSize);

  game_state *GameState = (game_state *)Memory->PermanentStorage;
  if (!Memory->IsInitialized){
    char *FileName = __FILE__;
    debug_read_file_result File = Memory->DEBUGPlatformReadEntireFile(FileName);
    if (File.Contents){
      Memory->DEBUGPlatformWriteEntireFile("z:/handmade_game/project/data/test.out", File.ContentsSize, File.Contents);
      Memory->DEBUGPlatformFreeFileMemory(File.Contents);
    }

    GameState->ToneHz = 256;
    GameState->tSine = 0.0f;

    GameState->PlayerX = 100;
    GameState->PlayerY = 100;
    //TODO: This may be more appropriate to do in the platform layer
    Memory->IsInitialized = true;
  }

  //NOTE: Input0 is usually Keyboard
  for (int ControllerIndex = 0; ControllerIndex < ArrayCount(Input->Controllers); ++ControllerIndex){
    game_controller_input *Controller = GetController(Input, ControllerIndex);
    if (Controller->IsAnalog){
      //NOTE: use analog movement tuning
      GameState->YOffset += (int)(4.0f*(Controller->StickAverageX));
      GameState->ToneHz = 256 + (int)(128.0f*(Controller->StickAverageY));
    }
    else {
      //NOTE: use digital movement tuning
      if (Controller->MoveLeft.EndedDown){
        GameState->XOffset -= 1;
      }
      if (Controller->MoveRight.EndedDown){
        GameState->XOffset += 1;
      }
      if (Controller->MoveDown.EndedDown){
        GameState->YOffset += 1;
      }
      if (Controller->MoveUp.EndedDown){
        GameState->YOffset -= 1;
      }
    }

    GameState->PlayerX += (int)(4.0f*(Controller->StickAverageX));
    GameState->PlayerY -= (int)(4.0f*(Controller->StickAverageY));

    if (GameState->tJump > -1.5)
    {
      GameState->PlayerY -= (int)(5*sinf(GameState->tJump));
    }
    if (Controller->ActionDown.EndedDown)
    {
      GameState->tJump = 1.0;
    }
    GameState->tJump -= 0.033f;
  }

  RenderWeirdGradient(Buffer, GameState->XOffset, GameState->YOffset);
  RenderPlayer(Buffer, GameState->PlayerX, GameState->PlayerY);
}

extern "C" GAME_GET_SOUND_SAMPLES(GameGetSoundSamples)
{
  game_state *GameState = (game_state *)Memory->PermanentStorage;
  GameOutputSound(GameState, SoundBuffer, GameState->ToneHz);
}
